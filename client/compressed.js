function Chunk(e,n,i){this.fromFile=null!==e,this.id=n,this.z=i;var t=Utils.AOItoTile(this.id);this.x=t.x,this.y=t.y,this.width=e.width||Engine.chunkWidth,this.height=e.height||Engine.chunkHeight,this.layers=[],this.layerData=[];for(var s=0;s<e.layers.length;s++){var a=this.fromFile?e.layers[s].data:null;this.layers.push([]),this.layerData.push(a)}}function Inventory(e){this.items={},this.maxSize=e,this.size=0}function Menu(e){this.container=[],this.panels=[],this.displayed=!1,this.makeTitle(e)}function Panel(e,n,i,t,s){this.container=[],this.slots=[],this.sprites=[],this.texts=[],this.nextItemSprite=0,this.test=[],this.x=e,this.y=n,this.previousX=this.x,this.previousY=this.y,this.width=i,this.height=t,this.verticalOffset=20,this.displayed=!1,this.displayInventory=!1,this.inventory=null,this.makeBody(),s&&this.addCapsule(20,-9,s),this.finalize()}function Rect(e,n,i,t){this.id=Geometry.lastrectID++,this.x=e,this.y=n,this.w=i,this.h=t,this.points=[],this.points.push(new PIXI.Point(e,n)),this.points.push(new PIXI.Point(e+i,n)),this.points.push(new PIXI.Point(e+i,n+t)),this.points.push(new PIXI.Point(e,n+t));for(var s=0;s<this.points.length;s++)this.points[s].i=s,this.points[s].rectID=this.id}var UIElement=new Phaser.Class({Extends:CustomSprite,initialize:function(e,n,i,t,s){CustomSprite.call(this,e,n,i),t&&this.setFrame(t),this.depth=Engine.UIDepth+1,this.setScrollFactor(0),this.setInteractive(),this.setDisplayOrigin(0,0),this.menu=s},setDownFrame:function(e){this.upFrame=this.frame.name,this.downFrame=e,this.handleDown=function(){this.setFrame(this.downFrame)}},handleClick:function(){this.downFrame&&this.setFrame(this.upFrame),this.menu.displayed?this.menu.hide():this.menu.display()}}),Animal=new Phaser.Class({Extends:Moving,initialize:function(e,n,i,t){var s=Engine.animalsData[i];Moving.call(this,e,n,s.sprite,t),this.setFrame(s.frame),this.setDisplayOrigin(0)},handleClick:function(){Client.startBattle(this.id)}}),Boot={key:"boot",preload:function(){Boot.mapDataLocation="/maps",Boot.masterKey="master",this.load.json(Boot.masterKey,Boot.mapDataLocation+"/master.json")},create:function(){var e=this.cache.json.get(Boot.masterKey);Boot.tilesets=e.tilesets,this.scene.start("main",e)}},Building=new Phaser.Class({Extends:CustomSprite,initialize:function(e,n,i,t,s){var a=Engine.buildingsData[i],r=Engine.settlementsData[t];CustomSprite.call(this,e*Engine.tileWidth,n*Engine.tileHeight,a.sprite),this.tileX=e,this.tileY=n,this.depth=Engine.buildingsDepth+(this.tileY+a.height/2/32)/1e3,this.id=s,this.settlement=t,this.inventory=new Inventory(100),this.chunk=Utils.tileToAOI({x:e,y:n});var o=Engine.baseViewHeight*Engine.tileHeight-200,l=a.name+" of "+r.name;this.panel=new Panel(0,o,300,200,l),this.panel.addRing(260,-10,"red","close",Engine.closePanel),this.panel.addSlots(3,3,5),this.panel.setInventory(this.inventory,!0),this.handleClick=Engine.togglePanel.bind(this);var h=new Phaser.Geom.Polygon(a.shape);this.setInteractive(h,Phaser.Geom.Polygon.Contains);var d,g;this.setDisplayOrigin(0),d=this.tileX,g=this.tileY,PFUtils.collisionsFromShape(h.points,d,g,a.width,a.height,Engine.collisions)}}),layerDepth={0:0,1:1,2:2,3:5};Chunk.prototype.drawLayers=function(){for(var e=0;e<this.layers.length;e++)for(var n=this.layers[e],i=this.layerData[e],t=0;t<i.length;t++){var s=i[t];if(0!=s&&null!=s){var a=t%this.width,r=Math.floor(t/this.width),o=this.x+a,l=this.y+r,h=this.drawTile(o,l,s,e);n.push(h),Engine.addCollision(o,l,s)}}},Chunk.prototype.removeLayers=function(){for(var e=0;e<this.layers.length;e++)for(var n=this.layers[e],i=0;i<n.length;i++)n[i].destroy()},Chunk.prototype.addTile=function(e,n,i,t){this.fromFile||this.children[t].data.add(e,n,i)},Chunk.prototype.orderTiles=function(){for(var e=0;e<this.children.length;e++)this.children[e].children.sort(function(e,n){return e.tileID<n.tileID})},Chunk.prototype.drawTile=function(e,n,i,t){if(!(e<0||n<0)&&i){var s=Engine.getTilesetFromTile(i),a=Engine.tilesets[s];void 0===a&&console.log("wrong",i,s,e,n),i-=a.firstgid;var r=Engine.scene.add.image(e*Engine.tileWidth,n*Engine.tileHeight,a.name,i);return r.setDisplayOrigin(0,0),r.tileID=i,r.depth=layerDepth[t],r}},Client={initEventName:"init",storageIDKey:"playerID",eventsQueue:[]},Client.socket=io.connect();var onevent=Client.socket.onevent;Client.socket.onevent=function(e){Engine.playerIsInitialized||e.data[0]==Client.initEventName||"dbError"==e.data[0]?onevent.call(this,e):Client.eventsQueue.push(e)},Client.emptyQueue=function(){for(var e=0;e<Client.eventsQueue.length;e++)onevent.call(Client.socket,Client.eventsQueue[e])},Client.getInitRequest=function(){return Client.isNewPlayer()?{new:!0}:{new:!1,id:Client.getPlayerID()}},Client.isNewPlayer=function(){return null===Client.getPlayerID()},Client.getPlayerID=function(){return localStorage.getItem(Client.storageIDKey)},Client.socket.on(Client.initEventName,function(e){console.log("Init packet received"),Client.socket.emit("ponq",e.stamp),Engine.initWorld(e.player)}),Client.socket.on("update",function(e){Client.socket.emit("ponq",e.stamp),e.local&&console.log(e.local),e.global&&console.log(e.global),e.global&&Engine.updateWorld(e.global),e.local&&Engine.updateSelf(e.local)}),Client.socket.on("pid",function(e){Client.setLocalData(e)}),Client.setLocalData=function(e){console.log("your ID : "+e),localStorage.setItem(Client.storageIDKey,e)},Client.requestData=function(){Client.socket.emit("init-world",Client.getInitRequest())},Client.sendPath=function(e){Client.socket.emit("path",e)},Client.startBattle=function(e){Client.socket.emit("battle",e)},Client.sendMapData=function(e,n){Client.socket.emit("mapdata",{id:e,data:n})};var CustomSprite=new Phaser.Class({Extends:Phaser.GameObjects.Sprite,initialize:function(e,n,i){Phaser.GameObjects.Sprite.call(this,Engine.scene,e,n,i),Engine.scene.add.displayList.add(this),Engine.scene.add.updateList.add(this)}}),Engine={baseViewWidth:32,baseViewHeight:18,tileWidth:32,tileHeight:32,buildingsDepth:2,playersDepth:2,UIDepth:20,key:"main",playerIsInitialized:!1,cursor:"url(/assets/sprites/cursor.png), auto"};Engine.preload=function(){this.load.spritesheet("hero","assets/sprites/hero.png",{frameWidth:64,frameHeight:64}),this.load.image("talk","assets/sprites/talk.png"),this.load.image("scroll","assets/sprites/scroll.png"),this.load.image("tome","assets/sprites/tome.png"),this.load.image("tools","assets/sprites/tools.png"),this.load.image("backpack","assets/sprites/backpack.png"),this.load.spritesheet("wolves","assets/sprites/wolves.png",{frameWidth:32,frameHeight:32}),this.load.image("fort","assets/sprites/buildings/fort.png"),this.load.atlas("UI","assets/sprites/ui.png","assets/sprites/ui.json"),this.load.atlas("items","assets/sprites/items.png","assets/sprites/items.json"),this.load.atlas("items2","assets/sprites/resources_full.png","assets/sprites/resources_full.json"),this.load.atlas("buildings","assets/sprites/buildings.png","assets/sprites/buildings.json"),this.load.spritesheet("marker","assets/sprites/marker.png",{frameWidth:32,frameHeight:32}),this.load.json("buildings","assets/data/buildings.json"),this.load.json("items","assets/data/items.json"),this.load.json("animals","assets/data/animals.json"),this.load.json("settlements","assets/data/settlements.json"),Engine.collidingTiles=[];for(var e=0,n=1;e<Boot.tilesets.length;e++){var i=Boot.tilesets[e],t=i.image.split("\\"),s="assets/tilesets/"+t[t.length-1];this.load.spritesheet(i.name,s,{frameWidth:i.tilewidth,frameHeight:i.tileheight});var a=Math.floor(i.imagewidth/Engine.tileWidth)*Math.floor(i.imageheight/Engine.tileHeight);Engine.collidingTiles=Engine.collidingTiles.concat(i.collisions.map(function(e){return e+n})),n+=a}console.log("Loading "+e+" tileset"+(e>1?"s":""))},Engine.create=function(e){World.readMasterData(e),Engine.nbLayers=e.nbLayers,Engine.nbLayers||console.log("WARNING : falsy number of layers : "+console.log(Engine.nbLayers)),Engine.mapDataLocation=Boot.mapDataLocation,console.log("Master file read, setting up world of size "+World.worldWidth+" x "+World.worldHeight+" with "+Engine.nbLayers+" layers"),Engine.tilesets=e.tilesets,Engine.tilesetMap={},Engine.chunks={},Engine.displayedChunks=[],Engine.mapDataCache={},Engine.players={},Engine.animals={},Engine.buildings={},Engine.displayedPlayers=new Set,Engine.displayedBuildings=new Set,Engine.displayedAnimals=new Set,Engine.inventory=Inventory,Engine.debug=!0,Engine.showHero=!Engine.debug||Utils.getPreference("showHero",!0),Engine.showGrid=!1,Engine.scene=this.scene.scene,Engine.camera=Engine.scene.cameras.main,Engine.camera.setBounds(0,0,Engine.worldWidth*Engine.tileWidth,Engine.worldHeight*Engine.tileHeight),Engine.camera.roundPixels=!0,Engine.buildingsData=Engine.scene.cache.json.get("buildings"),Engine.animalsData=Engine.scene.cache.json.get("animals"),Engine.itemsData=Engine.scene.cache.json.get("items"),Engine.settlementsData=Engine.scene.cache.json.get("settlements"),Engine.createMarker(),Engine.scene.game.canvas.style.cursor=Engine.cursor,Engine.scene.input.events.on("POINTER_DOWN_EVENT",Engine.handleDown),Engine.scene.input.events.on("POINTER_UP_EVENT",Engine.handleClick),Engine.scene.input.events.on("POINTER_MOVE_EVENT",Engine.trackMouse),Engine.scene.input.events.on("POINTER_OVER_EVENT",Engine.handleOver),Engine.scene.input.events.on("POINTER_OUT_EVENT",Engine.handleOut),Engine.scene.input.keyboard.events.on("KEY_DOWN_ENTER",Engine.toggleChatBar),Engine.collisions=new SpaceMap,Engine.PFgrid=new PF.Grid(0,0),Engine.PFfinder=PFUtils.getFInder(),PF.Grid.prototype.isWalkableAt=PFUtils.isWalkable,Engine.inMenu=!1,Engine.inPanel=!1,Engine.currentMenu=null,Engine.currentPanel=null,Engine.created=!0,Client.requestData()},Engine.createMarker=function(){Engine.marker=Engine.scene.add.sprite(0,0,"marker",0),Engine.marker.alpha=.8,Engine.marker.depth=1,Engine.marker.setDisplayOrigin(0,0),Engine.marker.previousTile={x:0,y:0}},Engine.initWorld=function(e){Engine.addHero(e.id,e.x,e.y,e.settlement),Engine.makeUI(),Engine.makeChatBar(),Engine.createAnimations(),Engine.playerIsInitialized=!0,Client.emptyQueue()},Engine.createAnimations=function(){Engine.scene.anims.create(config={key:"player_move_down",frames:Engine.scene.anims.generateFrameNumbers("hero",{start:35,end:38}),frameRate:10,repeat:-1}),Engine.scene.anims.create(config={key:"player_move_right",frames:Engine.scene.anims.generateFrameNumbers("hero",{start:5,end:8}),frameRate:10,repeat:-1}),Engine.scene.anims.create(config={key:"player_move_left",frames:Engine.scene.anims.generateFrameNumbers("hero",{start:51,end:54}),frameRate:10,repeat:-1}),Engine.scene.anims.create(config={key:"player_move_up",frames:Engine.scene.anims.generateFrameNumbers("hero",{start:20,end:23}),frameRate:10,repeat:-1})},Engine.makeChatBar=function(){var e=Engine.scene.game.config.height;Engine.chat=new Panel(362,e,300,96),Engine.chat.addSprite("talk",null,12,8),Engine.chat.setTweens(362,e,362,e-40)},Engine.toggleChatBar=function(){Engine.chat.toggle()},Engine.makeUI=function(){var e=830,n=[];n.push(Engine.scene.add.sprite(e,500,"UI","title-left")),e+=32,n.push(Engine.scene.add.tileSprite(e,500,115,64,"UI","title-center")),e+=115,n.push(Engine.scene.add.sprite(e,500,"UI","title-right")),n.forEach(function(e){e.depth=Engine.UIDepth,e.setScrollFactor(0),e.setDisplayOrigin(0,0),e.setInteractive()});var i=[];e=840,i.push(new UIElement(e,500,"backpack",null,Engine.makeInventory())),e+=50,i.push(new UIElement(e,500,"tools",null,Engine.makeCraftingMenu())),e+=50,i.push(new UIElement(e,500,"scroll",null,Engine.makeCharacterMenu()))},Engine.makeCraftingMenu=function(){var e=new Menu("Crafting"),n=new Panel(765,100,240,380,"Recipes");n.addLine("Buildings:"),n.addSlots(5,1,8),n.addLine("Items:"),n.addSlots(5,2,30),n.setInventory(Engine.player.recipes,!1),e.addPanel(n);var i=new Panel(450,100,290,380,"Combination");i.addSprite("UI","craftring",80,50),e.addPanel(i);var t=new Panel(40,100,390,380,"Items");return t.addSlots(10,9,Engine.player.inventory.maxSize),t.setInventory(Engine.player.inventory,!0),e.addPanel(t),e},Engine.makeInventory=function(){var e=new Menu("Inventory"),n=new Panel(665,100,340,380,"Equipment");n.addEquip(),e.addPanel(n);var i=new Panel(40,100,600,380,"Items");return i.addCapsule(500,-9,"1299","gold"),i.addSlots(15,9,Engine.player.inventory.maxSize),i.setInventory(Engine.player.inventory,!0),e.addPanel(i),e},Engine.makeCharacterMenu=function(){var e=new Menu("Character"),n=new Panel(665,100,340,380,"<Player name>");return n.addLine("Citizen of "+Engine.settlementsData[Engine.player.settlement].name),n.addLine("Level 1 Merchant  -   0/100 Class XP"),n.addLine("Level 1 citizen   -   0/100 Civic XP"),e.addPanel(n),e},Engine.addHero=function(e,n,i,t){Engine.player=Engine.addPlayer(e,n,i,t),Engine.camera.startFollow(Engine.player),Engine.player.inventory=new Inventory(25),Engine.player.recipes=new Inventory(10),Engine.updateInventory(Engine.player.recipes,{4:1}),Engine.updateEnvironment()},Engine.updateEnvironment=function(){for(var e=Utils.listAdjacentAOIs(Engine.player.chunk),n=e.diff(Engine.displayedChunks),i=Engine.displayedChunks.diff(e),t=0;t<i.length;t++)Engine.removeChunk(i[t]);for(var s=0;s<n.length;s++)Engine.displayChunk(n[s]);Engine.updateDisplayedEntities()},Engine.updateDisplayedEntities=function(){if(Engine.created){var e=Utils.listAdjacentAOIs(Engine.player.chunk);Engine.updateDisplay(Engine.displayedPlayers,Engine.players,e,Engine.removePlayer),Engine.updateDisplay(Engine.displayedBuildings,Engine.buildings,e,Engine.removeBuilding),Engine.updateDisplay(Engine.displayedAnimals,Engine.animals,e,Engine.removeAnimal)}},Engine.updateDisplay=function(e,n,i,t){e.forEach(function(e){var s=n[e];void 0===s.chunk&&console.log("WARNING: no chunk defined for ",s),s&&-1==i.indexOf(s.chunk)&&t(s.id)})},Engine.displayChunk=function(e){Engine.mapDataCache[e]?Engine.drawChunk(Engine.mapDataCache[e],e):Engine.loadJSON(Engine.mapDataLocation+"/chunk"+e+".json",Engine.drawChunk,e)},Engine.loadJSON=function(e,n,i){var t=new XMLHttpRequest;t.overrideMimeType("application/json"),t.open("GET",e,!0),t.onreadystatechange=function(){4==t.readyState&&"200"==t.status&&n(JSON.parse(t.responseText),i)},t.send(null)},Engine.drawChunk=function(e,n){var i=new Chunk(e,n,1);Engine.chunks[i.id]=i,Engine.mapDataCache[i.id]||(Engine.mapDataCache[i.id]=e),i.drawLayers(),Engine.displayedChunks.push(i.id)},Engine.removeChunk=function(e){Engine.chunks[e].removeLayers(),Engine.displayedChunks.splice(Engine.displayedChunks.indexOf(e),1)},Engine.addCollision=function(e,n,i){Engine.isColliding(i)&&Engine.collisions.add(n,e,1)},Engine.isColliding=function(e){for(var n=0;n<Engine.collidingTiles.length;n++){if(Engine.collidingTiles[n]>e)return!1;if(Engine.collidingTiles[n]==e)return!0}return!1},Engine.handleDown=function(e){e.gameObject&&e.gameObject.handleDown&&e.gameObject.handleDown()},Engine.handleClick=function(e){e.gameObject?e.gameObject.handleClick&&e.gameObject.handleClick():Engine.inMenu||(Engine.inPanel&&Engine.currentPanel.hide(),Engine.computePath(Engine.getMouseCoordinates(e)))},Engine.handleOver=function(e){e.gameObject&&"Building"==e.gameObject.constructor.name&&Engine.hideMarker()},Engine.handleOut=function(e){e.gameObject&&("Building"!=e.gameObject.constructor.name||Engine.inMenu||Engine.showMarker())},Engine.computePath=function(e){if(1!=Engine.collisions.get(e.tile.y,e.tile.x)){Engine.PFgrid.nodes=new Proxy(JSON.parse(JSON.stringify(Engine.collisions)),PFUtils.firstDimensionHandler);var n=Engine.PFfinder.findPath(Engine.player.tileX,Engine.player.tileY,e.tile.x,e.tile.y,Engine.PFgrid);Client.sendPath(n),Engine.player.move(n)}},Engine.updatePosition=function(e){e.x>e.previousPosition.x?e.orientation="right":e.x<e.previousPosition.x?e.orientation="left":e.y>e.previousPosition.y?e.orientation="down":e.y<e.previousPosition.y&&(e.orientation="up"),e.previousPosition={x:e.x,y:e.y},e.tileX=Math.floor(e.x/Engine.tileWidth),e.tileY=Math.floor(e.y/Engine.tileHeight),e.id==Engine.player.id&&(e.chunk=Utils.tileToAOI({x:e.tileX,y:e.tileY}),e.chunk!=e.previousChunk&&Engine.updateEnvironment(),e.previousChunk=e.chunk)},Engine.getMouseCoordinates=function(e){var n=Engine.camera.scrollX+e.x,i=Engine.camera.scrollY+e.y;return{tile:{x:Math.floor(n/Engine.tileWidth),y:Math.floor(i/Engine.tileHeight)},pixel:{x:n,y:i}}},Engine.trackMouse=function(e){var n=Engine.getMouseCoordinates(e);Engine.updateMarker(n.tile),Engine.debug&&(document.getElementById("pxx").innerHTML=n.pixel.x,document.getElementById("pxy").innerHTML=n.pixel.y,document.getElementById("tx").innerHTML=n.tile.x,document.getElementById("ty").innerHTML=n.tile.y,document.getElementById("aoi").innerHTML=Utils.tileToAOI(n.tile))},Engine.updateMarker=function(e){Engine.marker.x=e.x*Engine.tileWidth,Engine.marker.y=e.y*Engine.tileHeight,e.x==Engine.marker.previousTile.x&&e.y==Engine.marker.previousTile.y||(Engine.marker.previousTile=e,Engine.checkCollision(e)?Engine.marker.setFrame(1):Engine.marker.setFrame(0))},Engine.hideMarker=function(){Engine.marker.visible=!1},Engine.showMarker=function(){Engine.marker.visible=!0},Engine.checkCollision=function(e){if(!(Engine.displayedChunks.length<4))return!!Engine.collisions[e.y]&&!!Engine.collisions[e.y][e.x]},Engine.updateSelf=function(e){e.items&&Engine.updateInventory(Engine.player.inventory,e.items)},Engine.updateInventory=function(e,n){for(var i=0;i<n.length;i++){var t=n[i];e.update(t[0],t[1])}},Engine.updateWorld=function(e){if(e.newplayers)for(t=0;t<e.newplayers.length;t++){var n=e.newplayers[t],i=Engine.addPlayer(n.id,n.x,n.y,n.settlement);n.path&&i.move(n.path)}if(e.newbuildings)for(t=0;t<e.newbuildings.length;t++){s=e.newbuildings[t];Engine.addBuilding(s.id,s.x,s.y,s.type,s.settlement,s.resources)}if(e.newanimals)for(var t=0;t<e.newanimals.length;t++){var s=e.newanimals[t];Engine.addAnimal(s.id,s.x,s.y,s.type)}if(e.disconnected)for(var a=0;a<e.disconnected.length;a++)Engine.removePlayer(e.disconnected[a]);e.players&&Engine.traverseUpdateObject(e.players,Engine.players,Engine.updatePlayer)},Engine.traverseUpdateObject=function(e,n,i){Object.keys(e).forEach(function(t){n[t]&&i(n[t],e[t])})},Engine.updatePlayer=function(e,n){e.id!=Engine.player.id&&n.path&&e.move(n.path)},Engine.addPlayer=function(e,n,i,t){if(!Engine.playerIsInitialized||e!=Engine.player.id){var s=new Player(n,i,"hero",e);return s.settlement=t,Engine.players[e]=s,Engine.displayedPlayers.add(e),s}},Engine.addBuilding=function(e,n,i,t,s,a){var r=new Building(n,i,t,s,e);return Engine.updateInventory(r.inventory,a),Engine.buildings[e]=r,Engine.displayedBuildings.add(e),r},Engine.addAnimal=function(e,n,i,t){var s=new Animal(n,i,t,e);return Engine.animals[e]=s,Engine.displayedAnimals.add(e),s},Engine.removeBuilding=function(e){Engine.buildings[e].destroy(),Engine.displayedBuildings.delete(e),delete Engine.buildings[e]},Engine.removePlayer=function(e){Engine.players[e].destroy(),Engine.displayedPlayers.delete(e),delete Engine.players[e]},Engine.removeAnimal=function(e){Engine.animals[e].destroy(),Engine.displayedAnimals.delete(e),delete Engine.animals[e]},Engine.update=function(){},Engine.getTilesetFromTile=function(e){if(Engine.tilesetMap.hasOwnProperty(e))return Engine.tilesetMap[e];for(var n=0;n<Engine.tilesets.length;n++)if(e<Engine.tilesets[n].firstgid)return Engine.tilesetMap[e]=n-1,n-1;return Engine.tilesets.length-1},Engine.closePanel=function(){this.hide()},Engine.togglePanel=function(){Engine.inMenu||(this.panel.displayed?(this.panel.hide(),Engine.inPanel=!1,Engine.currentPanel=null):(Engine.inPanel&&Engine.currentPanel.hide(),this.panel.display(),Engine.inPanel=!0,Engine.currentPanel=this.panel))},Inventory.prototype.update=function(e,n){if(0==this.getNb(e)&&n>0){if(this.size==this.maxSize)return;this.size++}else this.size--;this.updateNb(e,n)},Inventory.prototype.getNb=function(e){return this.items.hasOwnProperty(e)?this.items[e]:0},Inventory.prototype.updateNb=function(e,n){this.items[e]=n};var VIEW_WIDTH=32,VIEW_HEIGHT=18,TILE_WIDTH=32,TILE_HEIGHT=32,config={type:Phaser.WEBGL,width:VIEW_WIDTH*TILE_WIDTH,height:VIEW_HEIGHT*TILE_HEIGHT,parent:"game",scene:[Boot,Engine]},game=new Phaser.Game(config);Menu.prototype.makeTitle=function(e){var n=Engine.scene.add.text(945,15,e,{font:"32px belwe",fill:"#ffffff",stroke:"#000000",strokeThickness:3});this.container.push(n);var i=945-n.width-32;this.container.push(Engine.scene.add.sprite(i,10,"UI","title-left")),i+=32,this.container.push(Engine.scene.add.tileSprite(i,10,n.width,64,"UI","title-center")),i+=n.width;var t=new UIElement(i,10,"UI","title-close",this);t.setDownFrame("title-close-pressed"),this.container.push(t),this.container.forEach(function(e){e.depth=Engine.UIDepth,e.setScrollFactor(0),e.setDisplayOrigin(0,0),e.setInteractive(),e.visible=!1}),n.depth=Engine.UIDepth+1,n.setOrigin(1,0)},Menu.prototype.addPanel=function(e){this.panels.push(e)},Menu.prototype.display=function(){Engine.inMenu&&Engine.currentMenu.hide(),Engine.inPanel&&Engine.currentPanel.hide();for(var e=0;e<this.container.length;e++)this.container[e].visible=!0;for(var n=0;n<this.panels.length;n++)this.panels[n].display();Engine.inMenu=!0,Engine.currentMenu=this,Engine.hideMarker(),this.displayed=!0},Menu.prototype.hide=function(){for(var e=0;e<this.container.length;e++)this.container[e].visible=!1;for(var n=0;n<this.panels.length;n++)this.panels[n].hide();Engine.inMenu=!1,Engine.currentMenu=null,Engine.showMarker(),this.displayed=!1};var Moving=new Phaser.Class({Extends:CustomSprite,initialize:function(e,n,i,t){CustomSprite.call(this,e*Engine.tileWidth,n*Engine.tileHeight,i),this.id=t,this.chunk=Utils.tileToAOI({x:e,y:n}),this.tileX=e,this.tileY=n,this.updateDepth(),this.previousPosition={x:e*Engine.tileWidth,y:n*Engine.tileHeight},this.orientation="down",this.previousOrientation=this.orientation,this.movement=null,this.setInteractive()},updateDepth:function(){this.depth=Engine.playersDepth+this.tileY/1e3},move:function(e){e.shift();for(var n=[],i=0;i<e.length;i++){var t=0==i?this.tileX:e[i-1][0],s=0==i?this.tileY:e[i-1][1],a=e[i][0],r=e[i][1],o=PFUtils.getDuration(t,s,a,r);n.push({targets:this,x:{value:a*Engine.tileWidth,duration:1e3*o},y:{value:r*Engine.tileHeight,duration:1e3*o}})}null!==this.movement&&(this.movement.stop(),this.updatePosition()),this.lastUpdateStamp=Date.now();var l=this;this.movement=Engine.scene.tweens.timeline({tweens:n,onStart:function(){l.previousOrientation=null},onUpdate:function(){Date.now()-l.lastUpdateStamp>5&&(l.updatePosition(),l.lastUpdateStamp=Date.now())},onComplete:function(){l.updatePosition(),l.anims.stop(),l.setFrame(l.restingFrames[l.orientation])}})},updatePosition:function(){this.x>this.previousPosition.x?this.orientation="right":this.x<this.previousPosition.x?this.orientation="left":this.y>this.previousPosition.y?this.orientation="down":this.y<this.previousPosition.y&&(this.orientation="up"),this.orientation!=this.previousOrientation&&(this.previousOrientation=this.orientation,this.anims.play(this.animsKeys["move_"+this.orientation])),this.previousPosition={x:this.x,y:this.y},this.tileX=Math.floor(this.x/Engine.tileWidth),this.tileY=Math.floor(this.y/Engine.tileHeight),this.updateDepth(),this.chunk=Utils.tileToAOI({x:this.tileX,y:this.tileY}),"Player"==this.constructor.name&&this.id==Engine.player.id&&(this.chunk!=this.previousChunk&&Engine.updateEnvironment(),this.previousChunk=this.chunk)}});Panel.prototype.makeBody=function(){var e=this.width-64,n=this.height-64,i=this.x,t=this.y;this.container.push(Engine.scene.add.sprite(i,t,"UI","panel-topleft")),i+=32,this.container.push(Engine.scene.add.tileSprite(i,t,e,32,"UI","panel-top")),i+=e,this.container.push(Engine.scene.add.sprite(i,t,"UI","panel-topright")),i=this.x,t+=32,this.container.push(Engine.scene.add.tileSprite(i,t,32,n,"UI","panel-left")),i+=32,this.container.push(Engine.scene.add.tileSprite(i,t,e,n,"UI","panel-center")),i+=e,this.container.push(Engine.scene.add.tileSprite(i,t,32,n,"UI","panel-right")),i=this.x,t+=n,this.container.push(Engine.scene.add.sprite(i,t,"UI","panel-bottomleft")),i+=32,this.container.push(Engine.scene.add.tileSprite(i,t,e,32,"UI","panel-bottom")),i+=e,this.container.push(Engine.scene.add.sprite(i,t,"UI","panel-bottomright"))},Panel.prototype.addCapsule=function(e,n,i,t){var s=this.x+e,a=this.y+n;if(t){var r=Engine.scene.add.sprite(s+8,a+6,"UI",t);r.depth=Engine.UIDepth+2}var o=(t?s+r.width:s)+10,l=t?a-1:a,h=Engine.scene.add.text(o,l,i,{font:"16px belwe",fill:"#ffffff",stroke:"#000000",strokeThickness:3}),d=h.width-25;t&&(d+=r.width),this.container.push(h),this.container.push(Engine.scene.add.sprite(s,a,"UI","capsule-left")),s+=24,this.container.push(Engine.scene.add.tileSprite(s,a,d,24,"UI","capsule-middle")),s+=d,this.container.push(Engine.scene.add.sprite(s,a,"UI","capsule-right")),t&&this.container.push(r)},Panel.prototype.addRing=function(e,n,i,t,s){var a=this.x+e,r=this.y+n;this.container.push(Engine.scene.add.sprite(a,r,"UI","ring")),a+=5,r+=5;var o=Engine.scene.add.sprite(a,r,"UI",i);o.upFrame=o.frame.name,this.container.push(o),a+=4,r+=4;var l=Engine.scene.add.sprite(a,r,"UI",t);this.container.push(l);var h=function(){this.setFrame(i+"-pressed")};o.handleClick=s.bind(this),l.handleClick=s.bind(this),o.handleDown=h.bind(o),l.handleDown=h.bind(o),this.finalize()},Panel.prototype.setInventory=function(e,n){this.displayInventory=!0,this.displayNumbers=n,this.inventory=e},Panel.prototype.addSlots=function(e,n,i){var t=0,s=0;this.verticalOffset+=5;for(var a=0;a<n;a++)for(var r=0;r<e&&!(a*e+r>=i);r++){var o="slots-",l=0;switch(a){case 0:o+="top";break;case n-1:o+="bottom";break;default:l++}switch(r){case 0:o+="left";break;case e-1:o+="right";break;default:l++}2==l&&(o+="middle"),t=r>0?2:0,s=a>0?2:0;var h=this.x+15+36*r+t,d=this.y+this.verticalOffset+36*a+s;this.slots.push({x:h,y:d}),this.container.push(Engine.scene.add.sprite(h,d,"UI",o))}this.verticalOffset+=36*n+5,this.finalize()},Panel.prototype.addEquip=function(){this.container.push(Engine.scene.add.sprite(this.x+150,this.y+50,"UI","equipment-slot")),this.container.push(Engine.scene.add.sprite(this.x+155,this.y+60,"UI","armor-shade")),this.container.push(Engine.scene.add.sprite(this.x+100,this.y+65,"UI","equipment-slot")),this.container.push(Engine.scene.add.sprite(this.x+108,this.y+75,"UI","gun-shade")),this.container.push(Engine.scene.add.sprite(this.x+100,this.y+115,"UI","equipment-slot")),this.container.push(Engine.scene.add.sprite(this.x+108,this.y+122,"UI","sword-shade")),this.container.push(Engine.scene.add.sprite(this.x+200,this.y+65,"UI","equipment-slot")),this.container.push(Engine.scene.add.sprite(this.x+208,this.y+75,"UI","shield-shade")),this.container.push(Engine.scene.add.sprite(this.x+200,this.y+15,"UI","equipment-slot")),this.container.push(Engine.scene.add.sprite(this.x+210,this.y+25,"UI","necklace-shade")),this.container.push(Engine.scene.add.sprite(this.x+150,this.y+100,"UI","equipment-slot")),this.container.push(Engine.scene.add.sprite(this.x+158,this.y+115,"UI","belt-shade")),this.container.push(Engine.scene.add.sprite(this.x+150,this.y+150,"UI","equipment-slot")),this.container.push(Engine.scene.add.sprite(this.x+155,this.y+165,"UI","boots-shade")),this.container.push(Engine.scene.add.sprite(this.x+100,this.y+220,"UI","equipment-slot")),this.container.push(Engine.scene.add.sprite(this.x+110,this.y+230,"UI","ring-shade")),this.container.push(Engine.scene.add.sprite(this.x+150,this.y+220,"UI","equipment-slot")),this.container.push(Engine.scene.add.sprite(this.x+160,this.y+230,"UI","ring-shade")),this.container.push(Engine.scene.add.sprite(this.x+200,this.y+220,"UI","equipment-slot")),this.container.push(Engine.scene.add.sprite(this.x+210,this.y+230,"UI","ring-shade")),this.finalize()},Panel.prototype.addLine=function(e){var n=Engine.scene.add.text(this.x+15,this.y+this.verticalOffset,e,{font:"14px belwe",fill:"#ffffff",stroke:"#000000",strokeThickness:3});this.container.push(n),this.verticalOffset+=20,this.finalize()},Panel.prototype.addSprite=function(e,n,i,t){var s=Engine.scene.add.sprite(this.x+i,this.y+t,e,n);this.container.push(s),this.finalize()},Panel.prototype.updatePosition=function(){var e=this.x-this.previousX,n=this.y-this.previousY;0==e&&0==n||(this.container.forEach(function(i){i.x+=e,i.y+=n}),this.previousX=this.x,this.previousY=this.y)},Panel.prototype.setTweens=function(e,n,i,t){var s=this;this.showTween=Engine.scene.tweens.add({targets:this,x:i,y:t,ease:"Bounce.easeOut",paused:!0,onStart:function(){},onUpdate:function(){s.updatePosition()},duration:200}),this.hideTween=Engine.scene.tweens.add({targets:this,x:e,y:n,paused:!0,onStart:function(){},onUpdate:function(){s.updatePosition()},onComplete:function(){s.hidePanel()},duration:200})},Panel.prototype.finalize=function(){this.container.forEach(function(e){var n="Text"==e.constructor.name;1!=e.depth&&e.depth||(e.depth=Engine.UIDepth),n&&e.depth++,e.setScrollFactor(0),e.setDisplayOrigin(0,0),e.setInteractive(),e.visible=!1})},Panel.prototype.getNextItemSprite=function(e){if(this.sprites.length<=this.nextItemSprite){var n=Engine.scene.add.sprite(0,0,"");n.setScrollFactor(0),n.depth=Engine.UIDepth+3,this.sprites.push(n)}var i=Engine.itemsData[e],t=this.sprites[this.nextItemSprite];return t.setTexture(i.atlas),t.setFrame(i.frame),t.setDisplayOrigin(Math.floor(t.frame.width/2),Math.floor(t.frame.height/2)),t.visible=!0,t},Panel.prototype.getNextText=function(e){if(this.texts.length<=this.nextItemSprite){var n=Engine.scene.add.text(100,10,"lorem ipsum",{font:"14px belwe",fill:"#ffffff",stroke:"#000000",strokeThickness:3});n.setScrollFactor(0),n.setOrigin(1,0),n.depth=Engine.UIDepth+4,this.texts.push(n)}var i=this.texts[this.nextItemSprite];return i.setText(this.inventory.getNb(e)),i.visible=!0,i},Panel.prototype.toggle=function(){this.displayed?this.hide():this.display()},Panel.prototype.display=function(){for(var e=0;e<this.container.length;e++)this.container[e].visible=!0,this.container[e].upFrame&&this.container[e].setFrame(this.container[e].upFrame);this.displayInventory&&this.displayTheInventory(),this.showTween&&this.showTween.play(),this.displayed=!0},Panel.prototype.displayTheInventory=function(){var e=0;for(var n in this.inventory.items)if(this.inventory.items.hasOwnProperty(n)){var i=this.getNextItemSprite(n),t=this.slots[e];i.setPosition(t.x+2+16,t.y+4+16),this.displayNumbers&&this.getNextText(n).setPosition(t.x+37,t.y+18),e++,this.nextItemSprite++}},Panel.prototype.hide=function(){this.hideTween?this.hideTween.play():this.hidePanel()},Panel.prototype.hidePanel=function(){for(var e=0;e<this.container.length;e++)this.container[e].visible=!1;this.displayInventory&&this.hideInventory(),this.displayed=!1},Panel.prototype.hideInventory=function(){for(var e=0;e<this.sprites.length;e++)this.sprites[e].visible=!1,this.texts[e]&&(this.texts[e].visible=!1);this.nextItemSprite=0};var Player=new Phaser.Class({Extends:Moving,initialize:function(e,n,i,t){Moving.call(this,e,n,i,t),this.setFrame(33),this.displayOriginX=16;var s=Engine.baseViewHeight*Engine.tileHeight-100;this.panel=new Panel(0,s,300,100,"Player name"),this.panel.addRing(260,-10,"red","close",Engine.closePanel),this.handleClick=Engine.togglePanel.bind(this),this.animsKeys={move_down:"player_move_down",move_up:"player_move_up",move_right:"player_move_right",move_left:"player_move_left"},this.restingFrames={up:20,down:33,left:52,right:7}}});Rect.prototype.contains=function(e){return this.x<e.x&&e.x<this.x+this.w&&this.y<e.y&&e.y<this.y+this.h},Rect.prototype.findIntersects=function(e){var n=[],i=e.i;return void 0===i?n:(0==i?(n.push(this.projectRight(e)),n.push(this.projectDown(e))):1==i?(n.push(this.projectLeft(e)),n.push(this.projectDown(e))):2==i?(n.push(this.projectLeft(e)),n.push(this.projectUp(e))):3==i&&(n.push(this.projectRight(e)),n.push(this.projectUp(e))),n)},Rect.prototype.projectUp=function(e){return new PIXI.Point(e.x,this.y)},Rect.prototype.projectRight=function(e){return new PIXI.Point(this.x+this.w,e.y)},Rect.prototype.projectDown=function(e){return new PIXI.Point(e.x,this.y+this.h)},Rect.prototype.projectLeft=function(e){return new PIXI.Point(this.x,e.y)};